<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="generator" content="pandoc">
<meta name="viewport" content="width=device-width,initial-scale=1">

<meta name="author" content="Yiran Sheng">

<meta name="date" content="2016-03-04">

<title>Callback and CPS in JavaScript</title>


<meta name="viewport" content="width=device-width,initial-scale=1">














<link href="style/main.css" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css"></head>

<body>




<div class="container-fluid main-container">

<!-- tabsets -->



<!-- code folding -->






<div class="fluid-row" id="header">


<h1 class="title">Callback and CPS in JavaScript</h1>
<h4 class="author"><em>Yiran Sheng</em></h4>
<h4 class="date"><em>03/04/2016</em></h4>

</div>

<div id="TOC">
<ul>
<li><a href="#random-introduction">Random Introduction</a></li>
<li><a href="#continuation-vs.callback">Continuation vs. Callback</a></li>
<li><a href="#poor-mans-monad">Poor man’s Monad</a></li>
<li><a href="#cont.-monad-in-js">Cont. Monad in js</a></li>
<li><a href="#callcc">call/cc</a></li>
<li><a href="#asyncawait-and-do-notation">async/await, and <em>do</em> notation</a></li>
<li><a href="#next">next</a></li>
</ul>
</div>

<div id="random-introduction" class="section level2">
<h2>Random Introduction</h2>
<p>Continuation-passing style (CPS) is a style of programming in which control is passed explicitly in the form of a continuation (<a href="https://en.wikipedia.org/wiki/Continuation-passing_style">Wikipedia</a>). In this article, I will take a stab at establishing a somewhat solid basis of CPS in javaScript, specifically with a monadic interface. Most of the work here are more or less direct translation of Haskell code found in this tutorial:</p>
<p><strong><a href="https://en.wikibooks.org/wiki/Haskell/Continuation_passing_style">Haskell/Continuation passing style</a></strong></p>
<p>Before moving on, I’d like provide a few short paragraphs of recap on some articles on this topic that helped me understand both the motivation and inner workings of CPS.</p>
<p><strong><a href="http://www.2ality.com/2012/06/continuation-passing-style.html">②ality: Asynchronous programming and continuation-passing style in JavaScript</a></strong></p>
<p><strong><a href="http://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/">What color is your function?</a></strong></p>
<blockquote>
<p>… If you’re programming in JavaScript on Node.js, everytime you define a function that “returns” a value by invoking a callback, you just made a red function.</p>
</blockquote>
<p>This article [Spoiler Alert] illustrates the fundamental difficulties in composing direct style (normal) functions and callback taking functions (typically async in nature). Modern day javaScript has plenty of tools in dealing with the issue here: <code>Promise</code>, <code>async/await</code>, <code>generators</code>, <code>Observables/FRP</code>, golang style <code>CSP</code> and more. However, almost all of these newer constructs aim to eliminate the heavy usage of callbacks and try to turn callback hell into some innocent/synchronous looking code - either in imperative (eg. CSP) or functional style (eg. FRP).</p>
<p>Callback hell is an integral part of javaScript’s notoriety However, callback hell, or rather multiple level nested functions are <em>not</em> necessarily “considered harmful” in functional programming. For instance, consider some simple monadic comprehension code in Haskell:</p>
<div class="highlight"><pre><span></span><span class="nf">triplets</span> <span class="ow">=</span> <span class="kr">do</span> 

    <span class="n">x</span> <span class="ow">&lt;-</span> <span class="n">xs</span>

    <span class="n">y</span> <span class="ow">&lt;-</span> <span class="n">ys</span>

    <span class="n">z</span> <span class="ow">&lt;-</span> <span class="n">zs</span>

    <span class="n">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
</pre></div>
<p>which desugars to:</p>
<div class="highlight"><pre><span></span><span class="kr">let</span> <span class="n">triplets</span> <span class="ow">=</span> <span class="n">xs</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span>

                         <span class="n">ys</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">y</span> <span class="ow">-&gt;</span>

                                   <span class="n">zs</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">z</span> <span class="ow">-&gt;</span>

                                             <span class="n">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
</pre></div>
<p>This certainly looks like callback hell. In fact it is very common in Haskell to have functions deeply nested, and refer to bindings(variables) a few level of lexical scopes above. Obviously, there’s no <code>do</code> notation in javaScript to make nested functions less ugly looking, yet this leads me to thinking the nesting part in callback hell maybe is not that bad after all. I will expand a little bit more on this thought towards the end.</p>
<p><strong><a href="https://www.schoolofhaskell.com/user/dpiponi/the-mother-of-all-monads">The Mother of all Monads</a></strong></p>
<blockquote>
<p>There are some interesting consequences of this beyond Haskell. Many languages with support for continuations should be extensible to support monads. In particular, if there is an elegant notation for continuations, there should be one for monads too.</p>
</blockquote>
<p>It is refreshing to know composing CPS functions can be done implicitly in a monadic interface (<code>Cont</code> monad in Haskell), the article above proves the reverse is also true: first-class continuation can be used to represent and express monads. There’s no convinient way to define and use monad in javaScript, nor a concept of first-class continuation. However, callback taking functions are everywhere in javaScript both client and server side, therefore, it might interests us to settle on a specific implementation of CPS and build monads on top of it.</p>
<p>At this point, hopefully my motivation for this excersice becomes more clear. The rest of article will be deticated to too tasks:</p>
<ol style="list-style-type: decimal">
<li><p>Introduce and formalize a way to create “poor man’s monad” and use it to build <code>Cont</code> monad, as well as <code>call/cc</code> function</p></li>
<li><p>Implement a somewhat diciplined way of CPS, and use it to build generalized monads</p></li>
</ol>
</div>
<div id="continuation-vs.callback" class="section level2">
<h2>Continuation vs. Callback</h2>
<p>Broadly speaking, continuation is a special case of callback. If we have a function which takes a callback, say it’s an api from some library, there’s no knowing when, with what arguments, and how many times our callback gets invoked (or it gets invoked at all). To contrast with CPS, consider these two paragraphs from the <a href="https://en.wikipedia.org/wiki/Continuation-passing_style">Wikipedia page</a> of continuation passing style:</p>
<blockquote>
<p>A function written in continuation-passing style takes an extra argument: an explicit “continuation” i.e. a function of one argument. When the CPS function has computed its result value, it “returns” it by calling the continuation function with this value as the argument.</p>
</blockquote>
<blockquote>
<p>Note that in CPS, there is no implicit continuation—every call is a tail call. There is no “magic” here, as the continuation is simply explicitly passed.</p>
</blockquote>
<p>This implies a CPS function will typically call the continuation/callback function:</p>
<ul>
<li>only once</li>
<li>at its tail position (place where its direct style counter-part will simply return)</li>
</ul>
<p>Another distinction is whether or not a CPS function should return the result of calling continuation. This can be illustrated with the most trival CPS function <code>id</code>.</p>
<div class="highlight"><pre><span></span><span class="c1">// direct style </span>

<span class="kd">function</span> <span class="nx">id</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>

<span class="p">}</span>



<span class="c1">// cps implementation 1</span>

<span class="kd">function</span> <span class="nx">id_cps1</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">k</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>

<span class="p">}</span>



<span class="c1">// cps implementation 2</span>

<span class="kd">function</span> <span class="nx">id_cps2</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">k</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
<p>Haskell’s <code>Control.Monad.Cont</code> opts to implementation continuations similar to <code>id_cps2</code> above. This makes sense. Original concept of a continuation in Scheme is defined as a procedure instead of pure functions. In other words, a continuation can have side effects such as the procedure <code>print</code>. Haskell models continuation as pure functions, which means our <code>id_cps1</code> will essentially become:</p>
<div class="highlight"><pre><span></span><span class="kr">let</span> <span class="n">idCps1</span> <span class="n">x</span> <span class="n">k</span> <span class="ow">=</span> <span class="nb">()</span>
</pre></div>
<p>Certainly not very useful.</p>
<p>However, this lesson does not carry over to javaScript. In almost all cases, a function/api is designed to take a callback because it is asyncous, and the callback is simply invoked some time in the future and its results discarded. In other words, almost all the callback based functions in javaScript cannot be modeled using Haskell’s flavor of CPS; otherwise, we would’ve been able to do things like:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;file.txt&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

<span class="c1">// in reality contents evaluates to undefined</span>
</pre></div>
<p>In which case, practitioners probably won’t even bother, and just use:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;file.txt&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div id="poor-mans-monad" class="section level2">
<h2>Poor man’s Monad</h2>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">MyMonad</span> <span class="p">{</span>

  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>

    

  <span class="p">}</span>

  <span class="cm">/*</span>

<span class="cm">   * @param f - {function} a -&gt; MyMonad b</span>

<span class="cm">   */</span>

  <span class="nx">bind</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

  

  <span class="p">}</span>

  <span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">MyMonad</span><span class="p">.</span><span class="nx">unit</span><span class="p">(</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">));</span>

  <span class="p">}</span>

  <span class="nx">apply</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

      <span class="k">return</span> <span class="nx">MyMonad</span><span class="p">.</span><span class="nx">unit</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>

    <span class="p">}));</span>

  <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// :: a -&gt; MyMonad a</span>

<span class="nx">MyMonad</span><span class="p">.</span><span class="nx">unit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>



<span class="p">}</span>
</pre></div>
</div>
<div id="cont.-monad-in-js" class="section level2">
<h2>Cont. Monad in js</h2>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">Cont</span> <span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">async</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_func</span> <span class="o">=</span> <span class="nx">f</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_async</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">async</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">async</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">promise</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

  <span class="p">}</span>

<span class="p">}</span>

<span class="nx">Cont</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>

  <span class="nx">runCont</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_async</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">runContAsync_</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">runContSync_</span><span class="p">(</span><span class="nx">k</span><span class="p">);</span>

  <span class="p">},</span>

  <span class="nx">runContSync_</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_func</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">k</span><span class="p">);</span>

  <span class="p">},</span>

  <span class="nx">runContAsync_</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_func</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

      <span class="nx">f</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

          <span class="nx">resolve</span><span class="p">(</span><span class="nx">k</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">));</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

          <span class="nx">reject</span><span class="p">(</span><span class="nx">k</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">));</span> 

        <span class="p">}</span>

      <span class="p">});</span>

    <span class="p">});</span>

  <span class="p">},</span>

  <span class="nx">map</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">return</span> <span class="nx">Cont</span><span class="p">.</span><span class="nx">unit</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>

    <span class="p">});</span>

  <span class="p">},</span>

  <span class="nx">bind</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Cont</span><span class="p">(</span><span class="nx">k</span> <span class="o">=&gt;</span> <span class="p">{</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">runCont</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">newCont</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_async</span> <span class="o">?</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">:</span> <span class="nx">k</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

          <span class="nx">newCont</span> <span class="o">=</span> <span class="nx">f</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

          <span class="nx">newCont</span><span class="p">.</span><span class="nx">_async</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_async</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="nx">newCont</span><span class="p">.</span><span class="nx">async</span><span class="p">;</span>

          <span class="k">return</span> <span class="nx">newCont</span><span class="p">.</span><span class="nx">runCont</span><span class="p">(</span><span class="nx">k</span><span class="p">);</span>

        <span class="p">}</span>

      <span class="p">});</span>

    <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">_async</span><span class="p">);</span>

  <span class="p">},</span>

  <span class="nx">filter</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">return</span> <span class="nx">predicate</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">?</span> <span class="nx">Cont</span><span class="p">.</span><span class="nx">unit</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">:</span> <span class="nx">Cont</span><span class="p">.</span><span class="nx">empty</span><span class="p">;</span>

    <span class="p">});</span> 

  <span class="p">}</span>

<span class="p">};</span>
</pre></div>
</div>
<div id="callcc" class="section level2">
<h2>call/cc</h2>
</div>
<div id="asyncawait-and-do-notation" class="section level2">
<h2>async/await, and <em>do</em> notation</h2>
<table style="text-align:center" class="table table-condensed"><tr><td colspan="2" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left"></td><td>
<em>Dependent variable:</em>
</td></tr>
<tr><td></td><td colspan="1" style="border-bottom: 1px solid black"></td></tr>
<tr><td style="text-align:left"></td><td>
y
</td></tr>
<tr><td colspan="2" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">
x
</td><td>
2.026<sup>***</sup>
</td></tr>
<tr><td style="text-align:left"></td><td>
(0.182)
</td></tr>
<tr><td style="text-align:left"></td><td></td></tr>
<tr><td style="text-align:left">
Constant
</td><td>
1.086<sup>***</sup>
</td></tr>
<tr><td style="text-align:left"></td><td>
(0.182)
</td></tr>
<tr><td style="text-align:left"></td><td></td></tr>
<tr><td colspan="2" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">
Observations
</td><td>
1,000
</td></tr>
<tr><td style="text-align:left">
R<sup>2</sup>
</td><td>
0.110
</td></tr>
<tr><td style="text-align:left">
Adjusted R<sup>2</sup>
</td><td>
0.109
</td></tr>
<tr><td style="text-align:left">
Residual Std. Error
</td><td>
5.758 (df = 998)
</td></tr>
<tr><td style="text-align:left">
F Statistic
</td><td>
123.344<sup>***</sup> (df = 1; 998)
</td></tr>
<tr><td colspan="2" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">
<em>Note:</em>
</td><td style="text-align:right">
<sup><em></em></sup>p&lt;0.1; <sup><strong></strong></sup>p&lt;0.05; <sup></sup>p&lt;0.01
</td></tr>
</table>

</div>
<div id="next" class="section level2">
<h2>next</h2>
</div>




</div>



<!-- dynamically load mathjax for compatibility with self-contained -->


</body>
</html>
