<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="generator" content="pandoc">
<meta name="viewport" content="width=device-width,initial-scale=1">

<meta name="author" content="Yiran Sheng">

<meta name="date" content="2016-03-25">

<title>Functional JavaScript: An Example of Equational Reasoning</title>


<meta name="viewport" content="width=device-width,initial-scale=1">














<link href="style/main.css" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css"></head>

<body>




<div class="container-fluid main-container">

<!-- tabsets -->



<!-- code folding -->






<div class="fluid-row" id="header">


<h1 class="title">Functional JavaScript: An Example of Equational Reasoning</h1>
<h4 class="author"><em>Yiran Sheng</em></h4>
<h4 class="date"><em>03/25/2016</em></h4>

</div>


<p>In the past few years, functional programming has been gaining popularity in the javaScript community. There are many contributing factors to this trend. Facebook’s <code>React</code>, although not strictly functional, strongly encourages the use of pure functions and immutable data structures. <code>Elm</code>, <code>Rxjs</code> <code>beacon-js</code> etc. made (functional) reactive programming viable and dependable for browser UI works. In addition to library-level evolution, ES6 and <code>babel</code> made javaScript more expressive at a language level.</p>
<p>There are a lot of tutorials and introductions to functional programming in a javaScript context, most of which are fairly informative while at the same time pretty easy and straight-forward to follow for people already know a thing or two about javaScript. After all, javaScript developers have been familiar with higher-order, first-class functions for years.</p>
<p>However, to cover the full spectrum of functional programming ideas and abstractions, javaScript as a language proves to be an inadequate medium. JavaScript has first-class functions, closures, lambdas, some pattern-matching (destructuring) - but it also lacks native support for immutability, currying and reliable mechanism to manage side effects. The missing parts do not make functional programming in javaScript impossible or significantly harder - they make doing so more <em>dangerous</em> due to missing language-level guarantees.</p>
<p>In javaScript when writing functional code, one has to be extra careful about mutable states, the language does not provide a line of defense for you, it’s a programmer’s responsibility to mentally track mutations and object identities. This also makes reasoning about code harder, as a lot of functional laws and identities fail to hold in an impure environment.</p>
<p>Yes, strong immutability and function purity makes reasoning about code much easier. You probably already have heard of that. However, the ease is not just a mere byproduct of the requirement to track <em>less</em> things like state mutations, it is also empowered by a whole new universe of tools to dissect, analyze and understand your code at a deep level. These tools are better known as: logic and math. One such technique is known equational reasoning, enabled by referential transparency and being able to replace equals by equals in <em>all</em> contexts.</p>
<p>In this article, I will demonstrate this practice by focus solely on a key data structure in javaScript: <code>Array</code> and start with a new <a href="(http://bterlson.github.io/proposal-flatMap/)">proposed</a> Array prototype method <a href="http://bterlson.github.io/proposal-flatMap/"><code>flatMap</code></a>.</p>
<div id="implement-flatmap" class="section level2">
<h2>Implement <code>flatMap</code></h2>
<blockquote>
<p><code>Array.prototype.flatMap</code> first maps each element using a mapping function, then flattens the result into a new array. It is identical to a map followed by a flatten of depth 1.</p>
</blockquote>
<div class="highlight"><pre><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flatten</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">return</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(...</span><span class="k">this</span><span class="p">);</span>

<span class="p">};</span>

<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>

<span class="p">};</span>

<span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flatMap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">map_</span><span class="p">(</span><span class="nx">f</span><span class="p">).</span><span class="nx">flatten</span><span class="p">();</span>

<span class="p">};</span>
</pre></div>
<p>A few quick notes:</p>
<ul>
<li><p>The implementation of <code>flatten</code> takes advantage of that <code>concat</code> taking variable number of arguments and ES6 spread operator</p></li>
<li><p>javaScript <code>Array.prototype.map</code> passes each element, its index and the array itself to the mapping function. While convenient at times, can also be troublesome and non-intuitive in some cases:</p></li>
</ul>
<div class="highlight"><pre><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">)</span>
</pre></div>
<pre><code>[[1, 0, [1,2]], [2, 1, [1,2]]]</code></pre>
<ul>
<li>Therefore, we implement <code>map_</code> for arrays that will only pass elements to the mapping function. From here on in this article, when <code>map</code> is mentioned/used, it implicitly refers to <code>map_</code> defined above.</li>
</ul>
<div class="highlight"><pre><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">].</span><span class="nx">map_</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">);</span>
</pre></div>
<pre><code>[[1], [2]]</code></pre>
</div>
<div id="equational-reasoning-on-flatmap" class="section level2">
<h2>Equational Reasoning on <code>flatMap</code></h2>
<p><code>flatMap</code> is an interesting function. It is not obvious when and why you should use it. However, instead of giving some examples first, I will state and prove some invariants related to the function, and demonstrate an important aspect of functional programming practices: equational reasoning.</p>
<p><strong>Statement 1</strong>: for any value <code>x</code>, and function <code>f</code> where <code>f(x)</code> returns an array, <code>Array.of(x).flatMap(f)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>f(x)</code>.</p>
<p>Here, triple equal sign <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> reads as <em>is equivalent to</em>. I choose not to use equal sign “=” as equality in javaScript is some messy business. For practical purposes, <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> throughout the rest of the article can be interpreted as <strong>deeply equal</strong> or <strong>equal in value</strong>. For instance, we consider <code>new Array(1,2)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>new Array(1, 2)</code>.</p>
<p><strong>Statement 1</strong> expresses an invariant of our function <code>flatMap</code>. Given the implementation of <code>flatMap</code> and the stated pre-condition, the equivalence relationship holds true for any value of <code>x</code> and <code>f</code>. To see why this is true, let’s substitute the call to <code>flatMap</code> with its implementation details:</p>
<div class="highlight"><pre><span class="c1">// given some x and f</span>

<span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="err">≡</span> <span class="p">[</span><span class="nx">x</span><span class="p">];</span>

<span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="p">).</span><span class="nx">flatten</span><span class="p">()</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)].</span><span class="nx">flatten</span><span class="p">()</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
</pre></div>
<p>The above block obviously is not valid javaScript. What we have done instead is replacing expressions of function calls with the expression defined in corresponding function bodies, just text substitution. This is known as <a href="https://wiki.haskell.org/Referential_transparency">referential transparency</a>. The theory behind functional programming, lambda calculus formalizes this concept among many other things. Pragmatically, referential transparency is beneficial for understanding the program. We simply need to look at the declaration of a variable to understand its behavior, you can find and replace all function invocations with its returned expression in your source code and the resulting program will still run identically.</p>
<p>JavaScript is not referential transparent in general. But under some specified conditions like our treatment of <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> relationships, it can be model as a such. The style of analysis here is called equational reasoning, it’s a lot like doing mathematical proofs, in the forms of symbol manipulation and substitutions.</p>
<p>Now that we have “proved” <strong>Statement 1</strong>, under the principle of referential transparency, anywhere in javaScript source code, if we see an expression in the form of <code>Array.of(x).flatMap(f)</code> / <code>[x].flatMap(f)</code>, we can simply replace it with a simpler form: <code>f(x)</code>.</p>
<p>There are of course other similar statements we can come up with that are universally applicable. For example:</p>
<p><strong>Statement 2</strong>: let <code>xs</code> be any array, <code>xs.flatMap(Array.of)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>xs</code>.</p>
<p>Informally, we can illustrate this property with some pseudo code:</p>
<div class="highlight"><pre><span class="kd">let</span> <span class="nx">xs</span> <span class="o">=</span> <span class="p">[</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">x3</span><span class="p">];</span>



<span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">)</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">x3</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">).</span><span class="nx">flatten</span><span class="p">()</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">x1</span><span class="p">),</span> <span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">x2</span><span class="p">),</span> <span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">x3</span><span class="p">)].</span><span class="nx">flatten</span><span class="p">()</span>

  <span class="err">≡</span> <span class="p">[[</span><span class="nx">x1</span><span class="p">],[</span><span class="nx">x2</span><span class="p">],[</span><span class="nx">x3</span><span class="p">]].</span><span class="nx">flatten</span><span class="p">()</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">x3</span><span class="p">]</span>

  <span class="err">≡</span> <span class="nx">xs</span>
</pre></div>
<p>To prove it in a slightly more rigorous manner, let’s first provide an alternative implementation of <code>flatMap</code> using recursion:</p>
<div class="highlight"><pre><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flatMap2</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">[];</span>

  <span class="p">}</span>

  <span class="kd">let</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="p">...</span><span class="nx">rest</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap2</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">);</span>

<span class="p">}</span>
</pre></div>
<p>With this new definition of <code>flatMap</code>, let’s prove <strong>Statement 2</strong> by induction.</p>
<ul>
<li><p>First, consider <code>xs</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>[]</code>, then <code>xs.flatMap2(Array.of)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>[].flatMap2(Array.of)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>[]</code> (returned inside the <code>if (!this.length)</code> conditional block)</p></li>
<li><p>Next, suppose for any array of length k (k&gt;=0), <strong>Statement 2 holds</strong>, consider array <code>xs</code> of length k+1, and substitute argument <code>f</code> in body of <code>flatMap2</code> with <code>Array.of</code>:</p></li>
</ul>
<div class="highlight"><pre><span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap2</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">)</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="p">...</span><span class="nx">rest</span><span class="p">].</span><span class="nx">flatMap2</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">)</span>  <span class="c1">// rest.length === k</span>

  <span class="err">≡</span> <span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap2</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">))</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap2</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">))</span>

  <span class="err">≡</span> <span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">rest</span><span class="p">)</span> <span class="c1">// induction assumption</span>

  <span class="err">≡</span> <span class="nx">xs</span>  <span class="c1">// proves Statement 2</span>
</pre></div>
<ul>
<li>By induction, <strong>Statement 2</strong> holds for all arrays with length &gt;= 0</li>
</ul>
<p>Of course, we still have yet to ascertain that <code>flatMap2</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>flatMap</code>. To prove this, let’s first prove the following lemma:</p>
<p><strong>Lemma 1</strong>: for array <code>xs</code> of length k&gt;0, write <code>[x, ...rest]</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>xs</code>, we must have: <code>xs.flatMap(f)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>f(x).concat(rest.flatMap(f))</code> (note <code>flatMap</code> here refers to the original, non-recursive version)</p>
<div class="highlight"><pre><span class="c1">// xs.length &gt; 0</span>

<span class="kd">let</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">xs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>

<span class="kd">let</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="p">...</span><span class="nx">restx</span><span class="p">]</span> <span class="o">=</span> <span class="nx">xs</span><span class="p">;</span>

<span class="kd">let</span> <span class="p">[</span><span class="nx">y</span><span class="p">,</span> <span class="p">...</span><span class="nx">resty</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ys</span><span class="p">;</span>
</pre></div>
<p>By definition of <code>map</code>:</p>
<div class="highlight"><pre><span class="nx">resty</span> <span class="err">≡</span> <span class="nx">restx</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>

<span class="nx">y</span> <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
</pre></div>
<p>Next:</p>
<div class="highlight"><pre><span class="c1">// xs.length &gt; 0</span>

<span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>

  <span class="err">≡</span> <span class="nx">ys</span><span class="p">.</span><span class="nx">flatten</span><span class="p">()</span>  <span class="c1">// substitute xs.map(f) -&gt; ys</span>

  <span class="err">≡</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">ys</span><span class="p">)</span>  <span class="c1">// substitute in body of `flatten`</span>

  <span class="err">≡</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="p">...</span><span class="nx">resty</span><span class="p">)</span>

  <span class="err">≡</span> <span class="nx">y</span><span class="p">.</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">resty</span><span class="p">)</span> <span class="c1">// property of `concat` [1]</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">resty</span><span class="p">)</span> <span class="c1">// substitute y -&gt; f(x)</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">resty</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// property of concat [1]</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">resty</span><span class="p">.</span><span class="nx">flatten</span><span class="p">()</span> <span class="p">)</span> <span class="c1">// substitute `flatten`&#39;s body with function invocation</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">restx</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="p">).</span><span class="nx">flatten</span><span class="p">()</span> <span class="p">)</span> <span class="c1">// substitute resty -&gt; restx.map(f)</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">restx</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// substitute `flatMap`&#39;s body with function invocation</span>



<span class="c1">// Q.E.D.</span>
</pre></div>
<p><strong>Lemma 2</strong>: <code>[].flatMap(f)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>[].flatMap2(f)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>[]</code> for any <code>f</code>.</p>
<p>This follows naturally by the definition of <code>flatMap</code> and <code>flatMap2</code>. Armed with <strong>Lemma 1</strong> and <strong>Lemma 2</strong>, we can rewrite <code>flatMap</code> conditioning on whether the array it operates on is empty (length = 0) or not:</p>
<div class="highlight"><pre><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flatMap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// apply Lemma 2</span>

    <span class="k">return</span> <span class="p">[];</span>

  <span class="p">}</span>

  <span class="c1">// otherwise, `this.length` &gt; 0 </span>

  <span class="c1">// apply Lemma 1 here</span>

  <span class="kd">let</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="p">...</span><span class="nx">rest</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">);</span> 

<span class="p">}</span>
</pre></div>
<p>Removing comments, you will notice this is character by character identical to <code>flatMap2</code>, therefore: <code>flatMap</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>flatMap2</code> and we have proved <strong>Statement 2</strong>.</p>
<p>In addition, <strong>Lemma 1</strong> can be generalized even further to:</p>
<p><strong>Lemma 3</strong>: let <code>as</code> and <code>bs</code> be two arrays, then <code>( as.concat(bs) ).flatMap(f)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>as.flatMap(f).concat( bs.flatMap(f) )</code></p>
<p>This is the consequence of repeated applying <strong>Lemma 1</strong> on <code>as.concat(bs)</code> and cover bases with <strong>Lemma 2</strong> when required. The proof is left as an exercise for the reader.</p>
</div>
<div id="statement-3" class="section level2">
<h2>Statement 3</h2>
<p>For any array <code>xs</code> and suitable function <code>f</code> and <code>g</code>:</p>
<div class="highlight"><pre><span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span>

  <span class="err">≡</span> <span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
<div id="simple-example" class="section level3">
<h3>Simple Example</h3>
<p>This time, instead of immediately proving it, let’s demonstrate <strong>Statement 3</strong> with an example:</p>
<div class="highlight"><pre><span class="kr">const</span> <span class="nx">xs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">];</span>



<span class="kd">function</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;f1:&quot;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">,</span> <span class="s2">&quot;f2:&quot;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">];</span>    

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">g</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;g_&quot;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">];</span>

<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
</pre></div>
<pre><code>[&quot;g_f1:1&quot;, 
 &quot;g_f2:1&quot;, 
 &quot;g_f1:2&quot;, 
 &quot;g_f2:2&quot;, 
 &quot;g_f1:3&quot;, 
 &quot;g_f2:3&quot;]</code></pre>
<div class="highlight"><pre><span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>

<span class="p">});</span>
</pre></div>
<pre><code>[&quot;g_f1:1&quot;, 
 &quot;g_f2:1&quot;, 
 &quot;g_f1:2&quot;, 
 &quot;g_f2:2&quot;, 
 &quot;g_f1:3&quot;, 
 &quot;g_f2:3&quot;]</code></pre>
</div>
<div id="proof" class="section level3">
<h3>Proof</h3>
<p>When dealing with <strong>Statement 1 and 2</strong>, we have accumulated quite a few useful insights. Building on top of these, the proof of <strong>Statement 3</strong> almost writes itself.</p>
<p>First, <code>let h = x =&gt; f(x).flatMap(g)</code>, <strong>Statement 3</strong> can be written as: <code>xs.flatMap(f).flatMap(g)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>xs.flatMap(h)</code>.</p>
<p>Again, we will use induction. It’s trivial to see <strong>Statement 3</strong> holds when <code>xs</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>[]</code> by <strong>Lemma 2</strong>. Now suppose it holds true for array of length k, and consider array <code>xs</code> of length k+1.</p>
<div class="highlight"><pre><span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>

  <span class="err">≡</span> <span class="nx">h</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// applying Lemma 1</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// substitute the definition of h</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// induction assumption</span>
</pre></div>
<p>Also,</p>
<div class="highlight"><pre><span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span>

  <span class="err">≡</span> <span class="p">(</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">conat</span><span class="p">(</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">)</span> <span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="c1">// applying Lemma 1</span>

  <span class="c1">// applying Lemma 3, where as=f(x), bs=rest.flatMap(f)</span>

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">f</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
<p>Therefore, for xs of length k+1, <code>xs.flatMap(f).flatMap(g)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>xs.flatMap(h)</code></p>
<p>By induction <strong>Statement 3</strong> holds for array of any length.</p>
</div>
</div>
<div id="monad-laws" class="section level2">
<h2>Monad Laws</h2>
<p>Array with <code>flatMap</code> and <code>Array.of</code> (non-variadic version) forms a monad, known as list monad in Haskell. And <strong>Statement 1-3</strong> are essentially three <a href="https://wiki.haskell.org/Monad_laws">monad laws</a>:</p>
<ul>
<li>Left identify</li>
<li>Right identify</li>
<li>Associativity</li>
</ul>
<p>A loose translation of monad definition into javaScript: a monad is a “class” paired with:</p>
<ol style="list-style-type: decimal">
<li>a function <code>of</code> that takes a single value of some type and produces an instance from the “class”</li>
<li>a prototype method <code>flatMap</code> from the class that satisfies the three laws / <strong>Statements 1-3</strong></li>
</ol>
</div>
<div id="associativity-chaining-and-nesting" class="section level2">
<h2>Associativity, Chaining and Nesting</h2>
<p>Consider this code:</p>
<div class="highlight"><pre><span class="kr">const</span> <span class="nx">xs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">];</span>



<span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">xs</span>

  <span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">x</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>  

  <span class="p">})</span>

  <span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">:</span> <span class="p">[];</span>

  <span class="p">});</span>
</pre></div>
<p>By Associativity Law, we know we can rewrite the code as:</p>
<div class="highlight"><pre><span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">xs</span>

  <span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

      <span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

        <span class="k">return</span> <span class="nx">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">:</span> <span class="p">[];</span>

      <span class="p">});</span>

  <span class="p">})</span>
</pre></div>
<p>In both versions, <code>ys</code> will be:</p>
<pre><code>[2,4]</code></pre>
<p>In terms of style, the first version illustrates an <em>chainable</em> apis, which are first popularized the very <code>jQuery</code>. Chaining looks nice visually in source files and usually is able to concisely communicate the intent of sequential transformations/operations. There are generally two strategies in designing chainable apis:</p>
<ol style="list-style-type: decimal">
<li>Define classes with methods that returns new instance of the same “class” (meaning objects share the same prototype)</li>
<li><code>return this</code> as the last statement in chainable methods</li>
</ol>
<p>The second version is an example of <em>nesting</em>, and looks quite like the infamous callback hell. One of the recently invented abstraction in dealing with callback hell in async javaScript is <code>Promise</code>, which turns nested callbacks into a chain <code>Promise.then</code> calls. Such conversion is pretty similar to <code>flatMap</code> and application of Associativity Law. In fact, you probably have heard about it, <code>Promise</code> is somewhat monadic (though not without caveats, for one thing, <code>Promise.then</code> is an overloaded method that serves both a <code>map</code> and <code>flatMap</code>).</p>
<p>Therefore, we have learned <code>flatMap</code> and monads can be used to establish equivalence between chaining and nesting with the application of Associativity Law.</p>
</div>
<div id="power-of-composition" class="section level2">
<h2>Power of Composition</h2>
<p>Now back to the examples, the intent behind both version can be more clearly demonstrated by rewriting the code with more familiar apis:</p>
<div class="highlight"><pre><span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">xs</span>

  <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

  <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
<p>Interesting enough, it seems <code>flatMap</code> can be used as a building block for both <code>map</code> and <code>filter</code>. To make this work, let’s abstract out <code>mapping</code> and <code>filtering</code> as higher order functions:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">mapping</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)];</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">filtering</span><span class="p">(</span><span class="nx">predicate</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">predicate</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">?</span> <span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">:</span> <span class="p">[];</span>

<span class="p">}</span>
</pre></div>
<p>Both functions returns functions that is suitable to use in <code>flatMap</code>, meaning that they take a single value and returns array(s). In addition, recall our function <code>h</code> when proving <strong>Statement 3</strong>, which is a function that combines <code>f</code> and <code>g</code>:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">h</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">g</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>

  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
<p>Thinking about the type signature of <code>h</code>, it takes two array returning functions and returns another array returning function - essentially a special form function composition for array returning functions. It does have a proper name: Kleisli composition, and not surprisingly it composes Kleisli arrows (function <code>f</code> and <code>g</code>). In Haskell this function is usually used as an infix operator <code>&gt;=&gt;</code> (pronounced fish). By the way also, the reason why the third monad law is called Associativity Law becomes clear, when we express it in terms of Kleisli composition:</p>
<p><strong>Statement 3<sup>*</sup>:</strong></p>
<ol style="list-style-type: decimal">
<li>Let <code>f</code> and <code>g</code> and <code>h</code> be array returning functions</li>
<li>Let <code>&gt;=&gt;</code> denote Kleisli composition</li>
</ol>
<div class="highlight"><pre><span class="p">(</span><span class="n">f</span> <span class="o">&gt;=&gt;</span> <span class="n">g</span><span class="p">)</span> <span class="o">&gt;=&gt;</span> <span class="n">h</span> <span class="err">≡</span>  <span class="n">f</span> <span class="o">&gt;=&gt;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;=&gt;</span> <span class="n">h</span><span class="p">)</span>
</pre></div>
<p>See Footnote[2] for why <strong>Statement 3<sup>*</sup></strong> is the same as <strong>Statement 3</strong>.</p>
<p>For the rest of the article, let’s name <code>&gt;=&gt;</code> as <code>kcomp</code> (javascript does not have custom operators), and make it varadic:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">kcomp</span><span class="p">(...</span><span class="nx">funcs</span><span class="p">)</span> <span class="p">{</span>

  <span class="kr">const</span> <span class="nx">seed</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">x</span><span class="p">];</span>

  <span class="k">return</span> <span class="nx">funcs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">g</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">));</span>

  <span class="p">},</span> <span class="nx">seed</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
<p>Now back again to the examples, the chaining version of computing <code>ys</code> becomes:</p>
<div class="highlight"><pre><span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">xs</span>

  <span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span> <span class="nx">mapping</span><span class="p">(</span><span class="nx">x</span><span class="o">=&gt;</span><span class="nx">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

  <span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span> <span class="nx">filtering</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
<p>And the nesting version:</p>
<div class="highlight"><pre><span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">xs</span>

  <span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">kcomp</span><span class="p">(</span>

    <span class="nx">mapping</span><span class="p">(</span><span class="nx">x</span><span class="o">=&gt;</span><span class="nx">x</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>

    <span class="nx">filtering</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>

  <span class="p">));</span>
</pre></div>
<p>Oh, wait, the nesting has gone away. Even better, we can do more:</p>
<div class="highlight"><pre><span class="kr">const</span> <span class="nx">transformation</span> <span class="o">=</span> 

  <span class="nx">kcomp</span><span class="p">(</span>

    <span class="nx">mapping</span><span class="p">(</span> <span class="nx">x</span><span class="o">=&gt;</span> <span class="nx">x</span><span class="o">+</span><span class="mi">1</span> <span class="p">),</span>

    <span class="nx">mapping</span><span class="p">(</span> <span class="nx">x</span><span class="o">=&gt;</span> <span class="nx">x</span><span class="o">*</span><span class="nx">x</span> <span class="p">),</span>

    <span class="nx">filtering</span><span class="p">(</span> <span class="nx">x</span><span class="o">=&gt;</span> <span class="nx">x</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>

    <span class="nx">filtering</span><span class="p">(</span> <span class="nx">filterFunc</span> <span class="p">)</span>

    <span class="c1">// ...</span>

  <span class="p">);</span>

  

<span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">xs</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">transformation</span><span class="p">);</span>
</pre></div>
<p>This style might have reminded you of <a href="http://phuu.net/2014/08/31/csp-and-transducers.html">transducers</a>. For example using <a href="https://github.com/cognitect-labs/transducers-js"><code>transducer-js</code></a> library:</p>
<div class="highlight"><pre><span class="kr">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">transducers</span><span class="p">;</span>



<span class="kr">const</span> <span class="nx">xf</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">comp</span><span class="p">(</span> <span class="c1">// plain function composition</span>

  <span class="nx">t</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">x</span><span class="o">=&gt;</span> <span class="nx">x</span><span class="o">+</span><span class="mi">1</span> <span class="p">),</span>

  <span class="nx">t</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">x</span><span class="o">=&gt;</span> <span class="nx">x</span><span class="o">*</span><span class="nx">x</span> <span class="p">),</span>

  <span class="nx">t</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nx">x</span><span class="o">=&gt;</span> <span class="nx">x</span><span class="o">%</span><span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span>

  <span class="c1">// ... </span>

<span class="p">);</span>



<span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">into</span><span class="p">([],</span> <span class="nx">xf</span><span class="p">,</span> <span class="nx">xs</span><span class="p">);</span>  <span class="c1">// calling Array.prototype.reduce by t.into</span>
</pre></div>
<p>Transducers accomplish their task by transforming reducing functions with plain function composition, and feed the composed reducer to collection’s <code>reduce</code> operation. <code>kcomp</code> and <code>flatMap</code> compose Kleisli arrows (for Arrays, this simply mean array returning functions), and feed composed Kleisli arrow to a final <code>flatMap</code> operation. If you suspect some deep connections here, this <a href="http://tel.github.io/posts/typing-transducers/">post: Typing Transducers (as Kleisli arrows)</a> offers a good analysis.</p>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>This article is in essence, an introduction to equational reasoning and Kleisli arrows with javaScript syntax. We have bypassed some prerequisites, namely a proper foundation of lambda calculus and category theory. However, the idea is not to shy away from these mathematical topics, rather it is to show an alternative mental model of javaScript code. Rather than model programs as variables and statements that mutates them in sequence, we can think programs as structures with hidden equivalence relationships between them. The only necessary technique is expression substitution. Throughout the article, we have repeatedly replaced function invocations with function bodies and the other way around.</p>
</div>
<div id="footnotes" class="section level2">
<h2>Footnotes</h2>
<div id="concat-and-monoids" class="section level3">
<h3>[1] <code>concat</code> and monoids</h3>
<p><code>Array.prototype.concat</code> has the following syntax:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">new_array</span> <span class="o">=</span> <span class="nx">old_array</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">value1</span><span class="p">[,</span> <span class="nx">value2</span><span class="p">[,</span> <span class="p">...[,</span> <span class="nx">valueN</span><span class="p">]]])</span>
</pre></div>
<p>It is a varadic function. To start simple, let’s consider a version of <code>concat</code> with only one argument, or the binary <code>concat</code> op:</p>
<div class="highlight"><pre><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">concat_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">other</span><span class="p">);</span>

<span class="p">};</span>
</pre></div>
<p>It is easy to see:</p>
<ul>
<li><code>[].concat_(any_array)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>any_array</code></li>
<li><code>any_array.concat_([])</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>any_array</code></li>
</ul>
<p>Furthermore:</p>
<ul>
<li><code>a.concat_(b).conat_(c)</code> <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.081ex" viewbox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-2261" x="0" y="0"/>
</g>
</svg></span> <code>a.concat_( b.concat_(c) )</code></li>
</ul>
<p>These properties form the essential definition of a <a href="https://en.wikipedia.org/wiki/Monoid">monoid</a>. A monoid in a set theoretic view is defined as:</p>
<p>A monoid is a set <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.499ex" height="2.176ex" style="vertical-align: -0.338ex" viewbox="0 -791.3 645.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-53" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-53" x="0" y="0"/>
</g>
</svg></span> that is closed under an associative binary operation <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.647ex" height="1.176ex" style="vertical-align: 0.439ex" viewbox="0 -432.6 278.5 506.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-22C5" x="0" y="0"/>
</g>
</svg></span> and has an identity element <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.172ex" height="2.176ex" style="vertical-align: -0.338ex" viewbox="0 -791.3 504.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-49" x="0" y="0"/>
</g>
</svg></span> in <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.499ex" height="2.176ex" style="vertical-align: -0.338ex" viewbox="0 -791.3 645.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-53" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-53" x="0" y="0"/>
</g>
</svg></span> such that for all <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.57ex" height="2.176ex" style="vertical-align: -0.338ex" viewbox="0 -791.3 2398.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"/>
<path stroke-width="1" id="E1-MJMATHI-53" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-61" x="0" y="0"/>
 <use xlink:href="#E1-MJMAIN-2208" x="807" y="0"/>
 <use xlink:href="#E1-MJMATHI-53" x="1752" y="0"/>
</g>
</svg></span>, <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.588ex" height="2.176ex" style="vertical-align: -0.338ex" viewbox="0 -791.3 6711.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"/>
<path stroke-width="1" id="E1-MJMAIN-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-49" x="0" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="726" y="0"/>
 <use xlink:href="#E1-MJMATHI-61" x="1227" y="0"/>
 <use xlink:href="#E1-MJMAIN-3D" x="2034" y="0"/>
 <use xlink:href="#E1-MJMATHI-61" x="3091" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="3842" y="0"/>
 <use xlink:href="#E1-MJMATHI-49" x="4343" y="0"/>
 <use xlink:href="#E1-MJMAIN-3D" x="5125" y="0"/>
 <use xlink:href="#E1-MJMATHI-61" x="6182" y="0"/>
</g>
</svg></span>. A set of all <code>Array</code> is such a set, with <code>concat_</code> serving as the binary operation <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.647ex" height="1.176ex" style="vertical-align: 0.439ex" viewbox="0 -432.6 278.5 506.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-22C5" x="0" y="0"/>
</g>
</svg></span>.</p>
<p>In our proof earlier, we used the following property of array concatenation:</p>
<div class="highlight"><pre><span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="p">...</span><span class="nx">resty</span><span class="p">)</span> <span class="err">≡</span> <span class="nx">y</span><span class="p">.</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">resty</span><span class="p">)</span>
</pre></div>
<p>Rewrite this in a mathy notation, denote <code>[]</code> as <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.172ex" height="2.176ex" style="vertical-align: -0.338ex" viewbox="0 -791.3 504.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-49" x="0" y="0"/>
</g>
</svg></span>, <code>concat</code> as <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.647ex" height="1.176ex" style="vertical-align: 0.439ex" viewbox="0 -432.6 278.5 506.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-22C5" x="0" y="0"/>
</g>
</svg></span>:</p>
<p><span class="math eq"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="46.676ex" height="2.509ex" style="vertical-align: -0.671ex" viewbox="0 -791.3 20096.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"/>
<path stroke-width="1" id="E1-MJMAIN-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/>
<path stroke-width="1" id="E1-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/>
<path stroke-width="1" id="E1-MJMAIN-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"/>
<path stroke-width="1" id="E1-MJMAIN-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"/>
<path stroke-width="1" id="E1-MJMAIN-73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z"/>
<path stroke-width="1" id="E1-MJMAIN-74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"/>
<path stroke-width="1" id="E1-MJMAIN-5F" d="M0 -62V-25H499V-62H0Z"/>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"/>
<path stroke-width="1" id="E1-MJMAIN-6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-49" x="0" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="726" y="0"/>
 <use xlink:href="#E1-MJMATHI-79" x="1227" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="1947" y="0"/>
<g transform="translate(2447,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"/>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-72"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-65" x="392" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-73" x="837" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-74" x="1231" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-5F" x="1621" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="2121" y="0"/>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-22C5" x="5114" y="0"/>
 <use xlink:href="#E1-MJMAIN-2026" x="5615" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="7010" y="0"/>
<g transform="translate(7510,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"/>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-72"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-65" x="392" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-73" x="837" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-74" x="1231" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-5F" x="1621" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-6E" x="2121" y="0"/>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="10272" y="0"/>
 <use xlink:href="#E1-MJMATHI-79" x="11328" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="12048" y="0"/>
<g transform="translate(12549,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"/>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-72"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-65" x="392" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-73" x="837" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-74" x="1231" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-5F" x="1621" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="2121" y="0"/>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-22C5" x="15216" y="0"/>
 <use xlink:href="#E1-MJMAIN-2026" x="15716" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="17111" y="0"/>
<g transform="translate(17612,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"/>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-72"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-65" x="392" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-73" x="837" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-74" x="1231" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-5F" x="1621" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-6E" x="2121" y="0"/>
</g>
</g>
</g>
</svg></span></p>
<p>We also used:</p>
<div class="highlight"><pre><span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">resty</span><span class="p">)</span> 

  <span class="err">≡</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(...</span><span class="nx">resty</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
<p>Rewrite this in a mathy notation, denote <code>[]</code> as <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.172ex" height="2.176ex" style="vertical-align: -0.338ex" viewbox="0 -791.3 504.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-49" x="0" y="0"/>
</g>
</svg></span>, <code>concat</code> as <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.647ex" height="1.176ex" style="vertical-align: 0.439ex" viewbox="0 -432.6 278.5 506.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMAIN-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMAIN-22C5" x="0" y="0"/>
</g>
</svg></span>, <code>f(x)</code> as <span class="math"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.23ex" height="1.676ex" style="vertical-align: -0.338ex" viewbox="0 -576.1 529.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-61" x="0" y="0"/>
</g>
</svg></span>:</p>
<p><span class="math eq"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="48.634ex" height="2.843ex" style="vertical-align: -0.838ex" viewbox="0 -863.1 20939.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/>
<path stroke-width="1" id="E1-MJMAIN-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/>
<path stroke-width="1" id="E1-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/>
<path stroke-width="1" id="E1-MJMAIN-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"/>
<path stroke-width="1" id="E1-MJMAIN-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"/>
<path stroke-width="1" id="E1-MJMAIN-73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z"/>
<path stroke-width="1" id="E1-MJMAIN-74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"/>
<path stroke-width="1" id="E1-MJMAIN-5F" d="M0 -62V-25H499V-62H0Z"/>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"/>
<path stroke-width="1" id="E1-MJMAIN-6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"/>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-61" x="0" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="751" y="0"/>
<g transform="translate(1252,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"/>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-72"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-65" x="392" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-73" x="837" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-74" x="1231" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-5F" x="1621" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="2121" y="0"/>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-22C5" x="3919" y="0"/>
 <use xlink:href="#E1-MJMAIN-2026" x="4419" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="5814" y="0"/>
<g transform="translate(6315,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"/>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-72"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-65" x="392" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-73" x="837" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-74" x="1231" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-5F" x="1621" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-6E" x="2121" y="0"/>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="9077" y="0"/>
 <use xlink:href="#E1-MJMATHI-61" x="10133" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="10885" y="0"/>
 <use xlink:href="#E1-MJMAIN-28" x="11385" y="0"/>
 <use xlink:href="#E1-MJMATHI-49" x="11775" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="12502" y="0"/>
<g transform="translate(13002,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"/>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-72"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-65" x="392" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-73" x="837" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-74" x="1231" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-5F" x="1621" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="2121" y="0"/>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-22C5" x="15669" y="0"/>
 <use xlink:href="#E1-MJMAIN-2026" x="16170" y="0"/>
 <use xlink:href="#E1-MJMAIN-22C5" x="17565" y="0"/>
<g transform="translate(18065,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"/>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-72"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-65" x="392" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-73" x="837" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-74" x="1231" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-5F" x="1621" y="0"/>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-6E" x="2121" y="0"/>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="20549" y="0"/>
</g>
</svg></span></p>
<p>Both properties are pretty self-evident. Knowing that array concatenation forms a monoid helps in coming up substitutions like these when doing equational reasoning, and carry the proof forward. In addition, you might have noticed the similarity of monoid laws and monad laws here. Let’s just throw the famous tongue in cheek here:</p>
<blockquote>
<p>A monad is just a monoid in the category of endofunctors, what’s the problem?</p>
</blockquote>
</div>
<div id="kleisli-composition-and-associativity-law" class="section level3">
<h3>[2] Kleisli Composition and Associativity Law</h3>
<p>It’s obvious that the infix notation of Kleisli Composition makes a more clear demonstration of Associativity Law. However, to stick to javaScript syntax, let’s rewrite the infix version with the <code>kcomp</code> function we have defined and used:</p>
<div class="highlight"><pre><span class="nx">kcomp</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="err">≡</span> <span class="nx">kcomp</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">kcomp</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">h</span><span class="p">))</span>
</pre></div>
<p>Next, we replace function invocation with function body, both left side and right side of the above equivalence relationship evaluates to a function:</p>
<div class="highlight"><pre><span class="nx">kcomp</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>

<span class="p">}</span>

<span class="nx">kcomp</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">kcomp</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">h</span><span class="p">))</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">g</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>

  <span class="p">})</span>

<span class="p">}</span>
</pre></div>
<p>To highlight only the function body:</p>
<div class="highlight"><pre><span class="c1">// kcomp(f, g, h) = function(x) {</span>

  <span class="cm">/* return */</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">g</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>

<span class="c1">// }</span>

<span class="c1">// kcomp(f, kcomp(g, h)) = function(x) {</span>

  <span class="cm">/* return */</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">g</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>

  <span class="p">})</span>

<span class="c1">// }</span>
</pre></div>
<p>It’s clear, the body expressions of both functions are in the form of <strong>Statement 3</strong>, which we have demonstrated to be equivalent.</p>
</div>
</div>




</div>



<!-- dynamically load mathjax for compatibility with self-contained -->


</body>
</html>